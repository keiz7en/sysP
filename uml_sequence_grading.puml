@startuml SubmissionGradingPublishingSequence
title Assignment Submission → Grading → Progress → Final Grade Publishing → Rating - EduAI

' Actors and Participants
actor Student as student
participant "Student UI\n(React)" as studentUI
participant "API Server\n(Django REST)" as api
participant "Assignment\nService" as assignmentSvc
participant "Database" as db
participant "Grading\nService" as gradingSvc
participant "Progress\nTracking" as progressSvc
participant "Notification\nService" as notifySvc
participant "WebSocket" as ws
participant "Teacher Dashboard" as teacherUI
actor Teacher as teacher
participant "AI Grading\nService" as aiGrading
participant "Grade\nCalculation" as gradeCalc

' ====================================
' PHASE 1: STUDENT SUBMITS ASSIGNMENT
' ====================================

group Student Submits Assignment

    student -> studentUI : Navigate to assignment\nUpload file & answers
    activate studentUI
    
    studentUI -> api : POST /api/students/assignments/submit/\n{assignment_id, student_id,\nsubmission_text, file_upload}
    activate api
    
    ' Validate submission
    api -> db : SELECT * FROM assignments\nWHERE id = assignment_id
    activate db
    db --> api : assignment_data\n{due_date, max_points, course_id}
    deactivate db
    
    api -> api : Check if submission is late\n(current_time > due_date)
    
    ' Check for duplicate submission
    api -> db : SELECT * FROM assignment_submissions\nWHERE assignment_id = ? AND student_id = ?
    activate db
    alt Submission already exists
        db --> api : existing_submission
        api -> db : UPDATE assignment_submissions\nSET submission_text, file_upload,\nsubmitted_at = now()
        db --> api : submission_updated
    else No existing submission
        db --> api : NULL
        api -> assignmentSvc : create_submission(assignment, student, data)
        activate assignmentSvc
        
        assignmentSvc -> db : INSERT assignment_submissions\n- assignment_id\n- student_id\n- submission_text\n- file_upload\n- submitted_at = now()\n- is_late = check_late_status\n- points_earned = NULL\n- graded_by = NULL
        db --> assignmentSvc : submission_id
        deactivate db
        
        assignmentSvc --> api : submission_created(submission_id)
        deactivate assignmentSvc
    end
    
    ' Notify teacher
    api -> notifySvc : notify_teacher_new_submission(\nteacher_id, submission_id, student_name, assignment_title)
    activate notifySvc
    notifySvc -> ws : push to teacher channel
    activate ws
    ws -> teacherUI : WS: "New submission received"
    deactivate ws
    notifySvc -> teacher : Email: "New submission to review"
    deactivate notifySvc
    
    api --> studentUI : 201 Created\n{submission_id, status: 'submitted'}
    deactivate api
    
    studentUI --> student : "Assignment submitted successfully"
    deactivate studentUI
end

note over student, db
Submission can be updated until teacher grades it.
Late submissions are flagged but still accepted.
end note

' ====================================
' PHASE 2: TEACHER GRADES SUBMISSION
' ====================================

group Teacher Grades Submission

    teacher -> teacherUI : Open "Grading Queue"
    activate teacherUI
    
    teacherUI -> api : GET /api/teachers/grading/pending/
    activate api
    api -> db : SELECT * FROM assignment_submissions AS s\nJOIN assignments AS a ON s.assignment_id = a.id\nJOIN courses AS c ON a.course_id = c.id\nWHERE c.instructor_id = teacher_id\nAND s.points_earned IS NULL\nORDER BY s.submitted_at
    activate db
    db --> api : pending_submissions[]
    deactivate db
    api --> teacherUI : submission_list[]
    deactivate api
    
    teacherUI --> teacher : Display submissions in queue
    
    teacher -> teacherUI : Click submission to review
    teacherUI -> api : GET /api/teachers/grading/submission/{submission_id}/
    activate api
    api -> db : SELECT * FROM assignment_submissions\nWHERE id = submission_id
    activate db
    db --> api : submission_details\n{submission_text, file_upload, assignment}
    deactivate db
    api --> teacherUI : submission_data
    deactivate api
    teacherUI --> teacher : Display submission details
    
    ' Teacher grades the submission
    teacher -> teacherUI : Enter marks and feedback\nClick "Submit Grade"
    teacherUI -> api : POST /api/teachers/grading/grade/\n{submission_id, teacher_id,\npoints_earned, feedback}
    activate api
    
    api -> gradingSvc : grade_submission(\nsubmission_id, teacher, marks, feedback)
    activate gradingSvc
    
    ' Validate marks
    gradingSvc -> db : SELECT max_points FROM assignments\nWHERE id = assignment_id
    activate db
    db --> gradingSvc : max_points
    deactivate db
    
    gradingSvc -> gradingSvc : Validate points_earned <= max_points
    
    ' Update submission with grade
    gradingSvc -> db : BEGIN TRANSACTION
    activate db
    gradingSvc -> db : UPDATE assignment_submissions SET\n- points_earned = marks\n- feedback = feedback\n- graded_at = now()\n- graded_by = teacher_id
    db --> gradingSvc : OK (1 row updated)
    
    ' Update learning analytics
    gradingSvc -> db : INSERT OR UPDATE learning_analytics\nSET assignment_completion_rate++
    db --> gradingSvc : analytics_updated
    
    gradingSvc -> db : COMMIT TRANSACTION
    deactivate db
    
    gradingSvc --> api : grading_complete(submission_id, marks)
    
    ' Trigger progress update
    gradingSvc -> progressSvc : update_progress_after_grading(\nsubmission_id)
    deactivate gradingSvc
    
    deactivate api
end

' ====================================
' PHASE 3: PROGRESS TRACKING UPDATE
' ====================================

group Progress Tracking & Completion Check

    activate progressSvc
    
    ' Get enrollment and assignment data
    progressSvc -> db : SELECT e.* FROM course_enrollments AS e\nJOIN assignment_submissions AS s ON e.student_id = s.student_id\nWHERE s.id = submission_id
    activate db
    db --> progressSvc : enrollment_data
    deactivate db
    
    ' Count completed tasks
    progressSvc -> db : SELECT COUNT(*) as total_assignments\nFROM assignments\nWHERE course_id = enrollment.course_id\nAND is_published = True
    activate db
    db --> progressSvc : total_assignments
    
    progressSvc -> db : SELECT COUNT(*) as graded_submissions\nFROM assignment_submissions AS s\nJOIN assignments AS a ON s.assignment_id = a.id\nWHERE s.student_id = enrollment.student_id\nAND a.course_id = enrollment.course_id\nAND s.points_earned IS NOT NULL
    db --> progressSvc : graded_count
    deactivate db
    
    ' Calculate completion percentage
    progressSvc -> progressSvc : completion_percentage =\n(graded_count / total_assignments) * 100
    
    ' Update enrollment progress
    progressSvc -> db : UPDATE course_enrollments\nSET completion_percentage = calculated_value\nWHERE id = enrollment_id
    activate db
    db --> progressSvc : OK
    deactivate db
    
    ' Check if course is completed
    alt completion_percentage >= 100
        progressSvc -> gradeCalc : calculate_final_grade(enrollment_id)
        activate gradeCalc
        
        note over gradeCalc
        Final grade calculation triggered
        when all assignments are graded
        end note
        
    else completion_percentage < 100
        progressSvc --> api : progress_updated\n{completion: <100%, not_ready_for_grading}
    end
    
    progressSvc --> gradingSvc : progress_tracking_complete
    deactivate progressSvc
    
    ' Notify student
    activate api
    api -> notifySvc : notify_student_submission_graded(\nstudent_id, submission_id, marks, feedback)
    activate notifySvc
    notifySvc -> ws : push to student channel
    activate ws
    ws -> studentUI : WS: "Submission graded"
    deactivate ws
    notifySvc -> student : Email: "Your submission has been graded"
    deactivate notifySvc
    
    api --> teacherUI : 200 OK\n{grading_status: 'success'}
    deactivate api
    teacherUI --> teacher : "Grade submitted successfully"
    deactivate teacherUI
end

' ====================================
' PHASE 4: FINAL GRADE CALCULATION
' ====================================

group Final Grade Calculation (When 100% Complete)

    activate gradeCalc
    
    ' Aggregate all component scores
    gradeCalc -> db : SELECT AVG(points_earned / max_points * 100)\nFROM assignment_submissions AS s\nJOIN assignments AS a ON s.assignment_id = a.id\nWHERE s.student_id = ? AND a.course_id = ?\nAND a.assignment_type = 'homework'\nGROUP BY a.assignment_type
    activate db
    db --> gradeCalc : assignments_score
    
    gradeCalc -> db : SELECT AVG(points_earned / max_points * 100)\nFROM assignment_submissions AS s\nJOIN assignments AS a ON s.assignment_id = a.id\nWHERE assignment_type = 'quiz'
    db --> gradeCalc : quizzes_score
    
    gradeCalc -> db : SELECT AVG(points_earned / max_points * 100)\nFROM assignment_submissions AS s\nJOIN assignments AS a ON s.assignment_id = a.id\nWHERE assignment_type = 'exam'
    db --> gradeCalc : exams_score
    
    gradeCalc -> db : SELECT AVG(points_earned / max_points * 100)\nFROM assignment_submissions AS s\nJOIN assignments AS a ON s.assignment_id = a.id\nWHERE assignment_type = 'project'
    db --> gradeCalc : projects_score
    deactivate db
    
    ' Calculate weighted final score
    gradeCalc -> gradeCalc : final_score =\n(assignments_score * 0.3) +\n(quizzes_score * 0.2) +\n(exams_score * 0.4) +\n(projects_score * 0.1)
    
    gradeCalc -> gradeCalc : letter_grade = calculate_letter_grade(final_score)
    gradeCalc -> gradeCalc : grade_points = calculate_grade_points(letter_grade)
    
    ' Create Grade record
    gradeCalc -> db : INSERT grades\n- enrollment_id\n- course_id\n- student_id\n- teacher_id\n- final_score\n- letter_grade\n- grade_points\n- assignments_score\n- quizzes_score\n- exams_score\n- projects_score\n- is_published = False\n- published_at = NULL
    activate db
    db --> gradeCalc : grade_id
    deactivate db
    
    gradeCalc --> api : final_grade_created(grade_id, not_published)
    
    ' Notify teacher to review and publish
    activate api
    api -> notifySvc : notify_teacher_grade_ready(\nteacher_id, grade_id, student_name, course_title)
    activate notifySvc
    notifySvc -> ws : push to teacher
    activate ws
    ws -> teacherUI : WS: "Final grade ready for review"
    deactivate ws
    notifySvc -> teacher : Email: "Review final grade before publishing"
    deactivate notifySvc
    deactivate api
    deactivate gradeCalc
end

note over gradeCalc, db
**Grade Calculation Formula:**
- Assignments: 30%
- Quizzes: 20%
- Exams: 40%
- Projects: 10%

Letter Grade Scale:
A (93-100), A- (90-92)
B+ (87-89), B (83-86), B- (80-82)
C+ (77-79), C (73-76), C- (70-72)
D (60-69), F (<60)
end note

' ====================================
' PHASE 5: TEACHER PUBLISHES GRADE
' ====================================

group Teacher Reviews and Publishes Final Grade

    teacher -> teacherUI : Open "Gradebook"\nClick "Pending Final Grades"
    activate teacherUI
    
    teacherUI -> api : GET /api/teachers/grades/pending/
    activate api
    api -> db : SELECT * FROM grades\nWHERE teacher_id = ? AND is_published = False
    activate db
    db --> api : pending_grades[]
    deactivate db
    api --> teacherUI : grade_list[]
    deactivate api
    
    teacherUI --> teacher : Display grades for review
    
    teacher -> teacherUI : Review grade → Click "Publish Grade"
    teacherUI -> api : POST /api/teachers/grades/{grade_id}/publish/
    activate api
    
    api -> gradeCalc : publish_grade(grade_id)
    activate gradeCalc
    
    gradeCalc -> db : BEGIN TRANSACTION
    activate db
    
    ' Publish grade
    gradeCalc -> db : UPDATE grades SET\n- is_published = True\n- published_at = now()
    db --> gradeCalc : OK
    
    ' Update enrollment to completed
    gradeCalc -> db : UPDATE course_enrollments SET\n- status = 'completed'\n- final_score = grade.final_score\n- grade = grade.letter_grade\n- completion_percentage = 100
    db --> gradeCalc : OK
    
    ' Update student GPA
    gradeCalc -> db : SELECT AVG(grade_points)\nFROM grades\nWHERE student_id = ?
    db --> gradeCalc : new_gpa
    
    gradeCalc -> db : UPDATE student_profiles\nSET current_gpa = new_gpa
    db --> gradeCalc : OK
    
    ' Create academic record
    gradeCalc -> db : INSERT academic_records\n- student_id\n- course_id\n- semester\n- year\n- grade = letter_grade\n- credits\n- gpa_points
    db --> gradeCalc : academic_record_created
    
    gradeCalc -> db : COMMIT TRANSACTION
    deactivate db
    
    gradeCalc --> api : grade_published_successfully
    deactivate gradeCalc
    
    ' Notify student
    api -> notifySvc : notify_student_grade_published(\nstudent_id, grade_id, final_score, letter_grade)
    activate notifySvc
    notifySvc -> ws : push to student
    activate ws
    ws -> studentUI : WS: "Final grade published!"
    deactivate ws
    notifySvc -> student : Email: "Course grade available"
    deactivate notifySvc
    
    api --> teacherUI : 200 OK\n{published: true}
    deactivate api
    
    teacherUI --> teacher : "Grade published successfully"
    deactivate teacherUI
end

' ====================================
' PHASE 6: STUDENT RATES TEACHER
' ====================================

group Student Rates Teacher (Post Completion)

    student -> studentUI : Navigate to completed course\nClick "Rate Teacher"
    activate studentUI
    
    studentUI --> student : Display rating form\n(1-5 stars + feedback)
    
    student -> studentUI : Submit rating (4 stars)\nand feedback
    
    studentUI -> api : POST /api/students/rate-teacher/\n{enrollment_id, teacher_id,\nrating: 4, feedback: "Great course!"}
    activate api
    
    ' Validate enrollment is completed
    api -> db : SELECT status FROM course_enrollments\nWHERE id = enrollment_id
    activate db
    db --> api : status = 'completed'
    deactivate db
    
    alt Enrollment not completed
        api --> studentUI : 400 Bad Request\n"Can only rate after completion"
    else Enrollment completed
        
        ' Check for duplicate rating
        api -> db : SELECT * FROM teacher_ratings\nWHERE enrollment_id = ?
        activate db
        alt Rating already exists
            db --> api : existing_rating
            api -> db : UPDATE teacher_ratings SET\nrating, feedback, updated_at = now()
            db --> api : rating_updated
        else No existing rating
            db --> api : NULL
            api -> db : INSERT teacher_ratings\n- student_id\n- teacher_id\n- course_id\n- enrollment_id\n- rating = 4\n- feedback\n- is_visible_to_teacher = True
            db --> api : rating_id
        end
        deactivate db
        
        ' Update teacher's average rating
        api -> db : SELECT AVG(rating), COUNT(*)\nFROM teacher_ratings\nWHERE teacher_id = ?
        activate db
        db --> api : avg_rating, total_ratings
        deactivate db
        
        api -> db : UPDATE teacher_profiles SET\n- average_rating = avg_rating\n- total_ratings = total_ratings
        activate db
        db --> api : teacher_updated
        deactivate db
        
        ' Notify teacher
        api -> notifySvc : notify_teacher_new_rating(\nteacher_id, rating_id, student_name, rating_value)
        activate notifySvc
        notifySvc -> ws : push to teacher
        activate ws
        ws -> teacherUI : WS: "New rating received"
        deactivate ws
        notifySvc -> teacher : Email: "You received a new rating"
        deactivate notifySvc
        
        ' Notify admin for quality tracking
        api -> notifySvc : notify_admin_rating(\nadmin_id, rating_id, teacher_id)
        activate notifySvc
        notifySvc --> api : admin_notified
        deactivate notifySvc
        
        api --> studentUI : 201 Created\n{rating_id, message: "Thank you for rating!"}
        deactivate api
        
        studentUI --> student : "Rating submitted successfully"
    end
    deactivate studentUI
end

' ====================================
' NOTES
' ====================================

note over db, progressSvc
**Progress Tracking:**
- Tracks completion after each grading
- completion_percentage = (graded_tasks / total_tasks) * 100
- Triggers final grade calculation at 100%
- Updates in real-time

**Transaction Safety:**
All critical updates (grading, grade publishing)
are wrapped in database transactions
for data consistency
end note

note over gradeCalc
**Grade Publishing Workflow:**
1. Teacher grades all assignments
2. System calculates final grade automatically
3. Grade remains unpublished (draft)
4. Teacher reviews calculated grade
5. Teacher publishes grade
6. Student notified + GPA updated
7. Enrollment marked 'completed'
8. Student can now rate teacher
end note

note over api, notifySvc
**Notification Events:**
1. Student submits → Teacher notified
2. Teacher grades → Student notified
3. Final grade ready → Teacher notified
4. Grade published → Student notified
5. Student rates → Teacher & Admin notified

All via: WebSocket + Email + In-app
end note

note over db
**Database Integrity:**
- Unique constraint: (student, assignment)
- Unique constraint: (enrollment, grade)
- Unique constraint: (enrollment, teacher_rating)
- Foreign key cascades properly set
- Status transitions enforced
end note

@enduml
