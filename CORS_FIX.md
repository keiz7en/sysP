# üîß Fix: "Failed to Fetch" - CORS Error

## Problem

Your frontend deployment shows:

```
Failed to fetch
```

This happens when your React frontend (https://sysp-1.onrender.com) tries to call your Django
backend (https://education-career.onrender.com) but gets blocked by CORS policy.

## Root Cause

**CORS (Cross-Origin Resource Sharing) not configured properly**

Your backend needs to explicitly allow requests from your frontend domain.

---

## üöÄ Quick Fix (5 minutes)

### Step 1: Update Backend CORS Settings

Go to your **backend** Render service (education-career) Dashboard:

1. Click **"Environment"** tab
2. Add/Update these environment variables:

```bash
CORS_ALLOWED_ORIGINS=https://sysp-1.onrender.com,http://localhost:5173,http://localhost:3000

ALLOWED_HOSTS=education-career.onrender.com,localhost,127.0.0.1
```

3. Click **"Save Changes"**
4. Wait for automatic redeploy (2-3 minutes)

### Step 2: Update Frontend API URL

Check your frontend API configuration:

**Option A: Using Environment Variable**

Create/update `.env` file in frontend root:

```bash
VITE_API_URL=https://education-career.onrender.com
VITE_API_BASE_URL=https://education-career.onrender.com/api
```

**Option B: Direct Configuration**

Update `src/services/api.ts` (or wherever your API client is):

```typescript
// Before:
const API_BASE_URL = 'http://localhost:8000/api'

// After:
const API_BASE_URL = import.meta.env.VITE_API_URL 
  ? `${import.meta.env.VITE_API_URL}/api`
  : 'https://education-career.onrender.com/api'
```

### Step 3: Redeploy Frontend

```bash
git add .
git commit -m "Update API URL for production"
git push origin main
```

---

## üìã Complete Fix Checklist

### Backend (Django) - education-career.onrender.com

#### 1. Environment Variables (Render Dashboard)

```bash
# CORS Configuration
CORS_ALLOWED_ORIGINS=https://sysp-1.onrender.com,http://localhost:5173

# Allowed Hosts
ALLOWED_HOSTS=education-career.onrender.com

# Other required vars
SECRET_KEY=<auto-generated>
DATABASE_URL=<postgres-url>
GEMINI_API_KEY=<your-key>
DEBUG=False
```

#### 2. Verify settings.py (should already be correct)

Your `backend/education_system/settings.py` should have:

```python
# CORS settings
cors_origins = os.getenv('CORS_ALLOWED_ORIGINS', 'http://localhost:3000,http://localhost:5173')
CORS_ALLOWED_ORIGINS = [origin.strip() for origin in cors_origins.split(',')]
CORS_ALLOW_CREDENTIALS = True
```

‚úÖ This is already in your code from previous fixes!

#### 3. Verify CORS Headers Middleware

In `settings.py`, ensure middleware order:

```python
MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',  # Must be first!
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',
    # ... other middleware
]
```

‚úÖ Already configured correctly!

### Frontend (React) - sysp-1.onrender.com

#### 1. Check API Configuration

Find where your API base URL is defined. Common locations:

**a) Environment Variable (Recommended)**

Create `.env` file:

```bash
VITE_API_URL=https://education-career.onrender.com
```

**b) In `src/services/api.ts`**

```typescript
import axios from 'axios'

const API_BASE_URL = import.meta.env.VITE_API_URL 
  ? `${import.meta.env.VITE_API_URL}/api`
  : 'https://education-career.onrender.com/api'

const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  withCredentials: true, // Important for CORS with credentials
})

export default api
```

#### 2. Update Render Environment Variables (Frontend)

In your frontend service (sysp-1) on Render:

1. Go to **"Environment"** tab
2. Add:
   ```bash
   VITE_API_URL=https://education-career.onrender.com
   ```
3. Save and redeploy

---

## üîç Testing the Fix

### 1. Test CORS from Browser Console

Open browser console on your frontend and run:

```javascript
fetch('https://education-career.onrender.com/api/', {
  method: 'GET',
  credentials: 'include'
})
.then(res => res.json())
.then(data => console.log('Success:', data))
.catch(err => console.error('Error:', err))
```

**Expected**: Should return API data  
**If fails**: CORS not configured correctly

### 2. Check Network Tab

1. Open DevTools ‚Üí Network tab
2. Trigger an API call
3. Look for:
    - Status: 200 (good) or CORS error (bad)
    - Response Headers should include:
      ```
      access-control-allow-origin: https://sysp-1.onrender.com
      access-control-allow-credentials: true
      ```

### 3. Test Backend Directly

```bash
curl -i https://education-career.onrender.com/api/
```

Should return API response with CORS headers.

---

## üêõ Troubleshooting

### Still Getting "Failed to Fetch"?

#### Issue 1: Mixed Content (HTTP/HTTPS)

**Problem**: Trying to call HTTP from HTTPS

**Solution**: Ensure both use HTTPS:

- Frontend: https://sysp-1.onrender.com ‚úÖ
- Backend: https://education-career.onrender.com ‚úÖ

#### Issue 2: Wrong API URL

**Check**: Open browser console and look for actual request URL

**Fix**: Update API base URL in frontend code

#### Issue 3: CORS Credentials Mismatch

**Problem**: Backend requires credentials but frontend doesn't send them

**Fix**: Add to API client:

```typescript
axios.create({
  baseURL: API_BASE_URL,
  withCredentials: true, // Add this!
})
```

#### Issue 4: Preflight OPTIONS Request Failing

**Symptom**: See OPTIONS request failing in Network tab

**Fix**: Django REST Framework handles this, but verify:

```python
# In settings.py
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.TokenAuthentication',
        'rest_framework.authentication.SessionAuthentication',
    ],
}
```

---

## üìù Environment Variables Summary

### Backend (education-career.onrender.com)

```bash
SECRET_KEY=<generated-by-render>
DEBUG=False
ALLOWED_HOSTS=education-career.onrender.com
DATABASE_URL=<postgres-url>
GEMINI_API_KEY=<your-key>
CORS_ALLOWED_ORIGINS=https://sysp-1.onrender.com
```

### Frontend (sysp-1.onrender.com)

```bash
VITE_API_URL=https://education-career.onrender.com
```

---

## üîß Quick Commands

### Check Backend CORS

```bash
# Test from command line
curl -H "Origin: https://sysp-1.onrender.com" \
     -H "Access-Control-Request-Method: GET" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS \
     https://education-career.onrender.com/api/
```

Should return:

```
access-control-allow-origin: https://sysp-1.onrender.com
access-control-allow-credentials: true
```

### Check Frontend API Calls

In browser console:

```javascript
console.log('API URL:', import.meta.env.VITE_API_URL)
```

---

## üéØ Complete Fix Flow

```
1. Backend: Add CORS_ALLOWED_ORIGINS env var
   ‚Üì
2. Backend: Wait for redeploy (2-3 min)
   ‚Üì
3. Frontend: Update API URL to backend domain
   ‚Üì
4. Frontend: Commit and push changes
   ‚Üì
5. Frontend: Wait for redeploy (2-3 min)
   ‚Üì
6. Test: Open frontend, check browser console
   ‚Üì
7. Success! API calls work ‚úÖ
```

---

## ‚úÖ Verification

After fixing:

1. **Open frontend**: https://sysp-1.onrender.com
2. **Open browser console** (F12)
3. **Try to login** or any API call
4. **Check console**: Should NOT see CORS errors
5. **Check Network tab**: Requests should succeed

---

## üÜò Still Not Working?

### Check Backend Logs

In Render dashboard ‚Üí Backend service ‚Üí Logs:

Look for:

```
‚úÖ Gemini AI initialized successfully
‚úÖ Gunicorn started
‚úÖ No CORS errors
```

### Check Frontend Console

Should see:

```javascript
‚úÖ API calls succeed
‚úÖ No "Failed to fetch" errors
‚úÖ No CORS policy errors
```

### Common Error Messages

| Error | Fix |
|-------|-----|
| "Failed to fetch" | CORS not configured |
| "CORS policy blocked" | Add frontend URL to CORS_ALLOWED_ORIGINS |
| "Mixed content" | Use HTTPS for both frontend and backend |
| "Network Error" | Check API URL is correct |

---

## üìö Additional Configuration

### For Authentication with Cookies

If using cookie-based auth:

**Backend `settings.py`:**

```python
CORS_ALLOW_CREDENTIALS = True
SESSION_COOKIE_SAMESITE = 'None'
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SAMESITE = 'None'
CSRF_COOKIE_SECURE = True
```

**Frontend API client:**

```typescript
axios.create({
  baseURL: API_BASE_URL,
  withCredentials: true,
})
```

---

## Summary

‚úÖ **Root Cause**: CORS blocking cross-origin requests  
‚úÖ **Fix**: Add frontend URL to backend CORS_ALLOWED_ORIGINS  
‚úÖ **Also Fix**: Update frontend API URL to backend domain  
‚úÖ **Time**: 5 minutes to configure, 5 minutes to redeploy

**Status**: Follow steps above and your frontend will connect to backend! üöÄ

---

**Last Updated**: 2025  
**Issue**: CORS "Failed to fetch"  
**Solution**: Configure CORS_ALLOWED_ORIGINS environment variable
